name: Deploy PVUF to Staging

on:
  push:
    branches:
      - F3-uf-skeleton-like
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy UserFrosting to pvuf.plazza.xyz
    environment: 
      name: staging
      url: https://pvuf.plazza.xyz/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: gd, mbstring, xml, curl, zip, mysql, pdo_mysql
          tools: composer:v2

      - name: Generate deployment identifier
        id: deployment
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          
          # Create build.json
          cat > build.json <<EOF
          {
            "commitHash": "${COMMIT_HASH}",
            "buildTimestamp": "${BUILD_TIMESTAMP}",
            "buildDate": "${BUILD_DATE}"
          }
          EOF
          
          echo "=== Deployment Info ==="
          cat build.json
          echo ""
          echo "Commit: ${COMMIT_SHORT}"
          echo "Build Timestamp: ${BUILD_TIMESTAMP}"
          echo "Build Date: ${BUILD_DATE}"

      - name: Install Composer dependencies
        run: |
          echo "Installing dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction
          echo "Dependencies installed successfully"

      - name: Prepare deployment artifact
        run: |
          echo "=== Preparing deployment artifact ==="
          mkdir -p /tmp/deploy
          
          # Copy application structure
          cp -r public /tmp/deploy/
          cp -r app /tmp/deploy/
          cp -r vendor /tmp/deploy/
          cp -r storage /tmp/deploy/
          
          # Copy configuration files
          cp composer.json /tmp/deploy/
          cp composer.lock /tmp/deploy/
          cp build.json /tmp/deploy/
          
          # Copy environment example
          cp .env.example /tmp/deploy/
          
          echo "=== Deployment artifact structure ==="
          ls -lah /tmp/deploy/
          du -sh /tmp/deploy/

      - name: Create .env file for staging
        run: |
          cat > /tmp/deploy/.env <<EOF
          # Staging Environment Configuration
          APP_ENV=staging
          APP_DEBUG=false
          APP_URL=https://pvuf.plazza.xyz
          
          # Database
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # Mail
          MAIL_MAILER=smtp
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME=PVUF
          
          # Security
          APP_KEY=${{ secrets.APP_KEY }}
          SESSION_LIFETIME=120
          SESSION_DRIVER=file
          
          # Cache
          CACHE_DRIVER=file
          
          # Logging
          LOG_LEVEL=info
          EOF
          
          echo ".env file created for staging"

      - name: Setup SSH with Passphrase Support
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          SSH_KEY_PASSPHRASE: ${{ secrets.DEPLOY_KEY_PASSPHRASE }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          mkdir -p ~/.ssh
          
          # Write private key
          cat > ~/.ssh/deploy_key <<'EOF'
          ${{ secrets.DEPLOY_KEY }}
          EOF
          
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -p ${DEPLOY_PORT:-22} ${DEPLOY_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Create a script to provide passphrase to ssh-add
          cat > /tmp/ssh_passphrase.sh <<'EOFPASS'
          #!/bin/bash
          echo "$SSH_KEY_PASSPHRASE"
          EOFPASS
          chmod +x /tmp/ssh_passphrase.sh
          
          # Start ssh-agent and add key with passphrase
          eval $(ssh-agent -s)
          export SSH_ASKPASS=/tmp/ssh_passphrase.sh
          export SSH_ASKPASS_REQUIRE=force
          echo "$SSH_KEY_PASSPHRASE" | setsid ssh-add ~/.ssh/deploy_key 2>&1 || true
          
          # Export agent info for subsequent steps
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

      - name: Test SSH connection
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          echo "Testing SSH connection to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PORT..."
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "echo 'SSH Connection successful!'; pwd; php --version" || {
            echo ""
            echo "ERROR: SSH connection failed!"
            exit 1
          }

      - name: Deploy application via SCP
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Starting deployment to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH..."
          
          # Create backup of existing deployment (if exists)
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST \
            "if [ -d $DEPLOY_PATH ]; then \
              cp -r $DEPLOY_PATH ${DEPLOY_PATH}_backup_$(date +%Y%m%d_%H%M%S); \
            fi"
          
          # Transfer the entire application
          scp -r -P $DEPLOY_PORT /tmp/deploy/* $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          
          echo "Files transferred successfully!"

      - name: Set permissions on server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST << 'EOSSH'
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Set proper permissions
            chmod -R 755 public/
            chmod -R 775 storage/
            
            # Ensure writable directories exist and are writable
            mkdir -p storage/logs storage/cache storage/sessions
            chmod -R 775 storage/
            
            echo "Permissions set successfully"
          EOSSH

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Verifying deployment..."
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST \
            "ls -lah $DEPLOY_PATH/ && echo '---' && \
             ls -lah $DEPLOY_PATH/public/ && echo '---' && \
             cat $DEPLOY_PATH/build.json"

      - name: Create deployment summary
        if: always()
        run: |
          cat <<EOF
          # Deployment Summary
          
          **Status:** Success ✓
          **Commit:** ${{ steps.deployment.outputs.commit_short }}
          **Build Timestamp:** ${{ steps.deployment.outputs.build_timestamp }}
          **Deployed to:** ${{ secrets.DEPLOY_HOST }}
          **Path:** ${{ secrets.DEPLOY_PATH }}
          **URL:** https://pvuf.plazza.xyz/
          
          ## Next Steps
          
          1. Change webroot in hosting panel to point to: ${{ secrets.DEPLOY_PATH }}/public
          2. Access https://pvuf.plazza.xyz/ to run UserFrosting installation
          3. Complete installation wizard with admin user credentials
          4. Verify MariaDB connection
          5. Test SMTP email sending
          
          EOF

  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Deployment failed
        run: |
          echo "❌ Deployment failed! Check the logs for details."
          exit 1
