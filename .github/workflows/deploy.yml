name: Deploy PVUF to Shared Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to pvuf.plazza.xyz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate deployment identifier
        id: deployment
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          
          # Create build.json
          cat > build.json <<EOF
          {
            "commitHash": "${COMMIT_HASH}",
            "buildTimestamp": "${BUILD_TIMESTAMP}",
            "buildDate": "${BUILD_DATE}"
          }
          EOF
          
          echo "=== Deployment Info ==="
          cat build.json
          echo ""
          echo "Commit: ${COMMIT_SHORT}"
          echo "Build Timestamp: ${BUILD_TIMESTAMP}"
          echo "Build Date: ${BUILD_DATE}"

      - name: Verify build artifact
        run: |
          echo "=== Files to be deployed ==="
          ls -lah index.php build.json

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          SSH_KEY_PASSPHRASE: ${{ secrets.DEPLOY_KEY_PASSPHRASE || '' }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          mkdir -p ~/.ssh
          
          # Write key with proper cleanup of whitespace
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          
          # Verify key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "ERROR: SSH private key format is invalid!"
            echo "Key should start with '-----BEGIN RSA PRIVATE KEY-----' or '-----BEGIN OPENSSH PRIVATE KEY-----'"
            exit 1
          fi
          
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts to avoid interactive prompt
          ssh-keyscan -p ${DEPLOY_PORT:-22} ${DEPLOY_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # If passphrase is provided, add key to ssh-agent
          if [ -n "$SSH_KEY_PASSPHRASE" ]; then
            eval $(ssh-agent -s)
            echo "$SSH_KEY_PASSPHRASE" | ssh-add -p ~/.ssh/deploy_key 2>&1 || {
              echo "ERROR: Failed to add key to ssh-agent"
              ssh-add -L
              exit 1
            }
          fi
          
          # Configure SSH to use our key
          cat > ~/.ssh/config <<EOF
          Host deploy
              HostName ${DEPLOY_HOST}
              User ${{ secrets.DEPLOY_USER }}
              Port ${DEPLOY_PORT:-22}
              IdentityFile ~/.ssh/deploy_key
              StrictHostKeyChecking accept-new
              UserKnownHostsFile ~/.ssh/known_hosts
              IdentitiesOnly yes
          EOF
          
          chmod 600 ~/.ssh/config
          
          # Debug: Show key info
          echo "=== SSH Key Debug Info ==="
          echo "Key file exists: $([ -f ~/.ssh/deploy_key ] && echo 'YES' || echo 'NO')"
          echo "Key permissions: $(stat -c '%a' ~/.ssh/deploy_key 2>/dev/null || echo 'N/A')"
          echo "Key type: $(ssh-keygen -l -f ~/.ssh/deploy_key 2>&1 | head -1 || echo 'Error reading key')"

      - name: Test SSH connection
        env:
          SSH_KEY_PASSPHRASE: ${{ secrets.DEPLOY_KEY_PASSPHRASE || '' }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          # If we set up ssh-agent in previous step, export the agent variables
          eval $(ssh-agent)
          
          # Re-add key if passphrase exists (for this step)
          if [ -n "$SSH_KEY_PASSPHRASE" ]; then
            echo "$SSH_KEY_PASSPHRASE" | ssh-add ~/.ssh/deploy_key 2>&1 || true
          fi
          
          # Test connection with verbose output
          ssh -vvv deploy "echo 'SSH Connection successful!'; pwd; php --version" || {
            echo ""
            echo "=== SSH Connection Debug ==="
            echo "Attempting direct SSH debug..."
            ssh -vvv -i ~/.ssh/deploy_key -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo test" || true
            echo ""
            echo "SSH connection failed. Checking connectivity..."
            ping -c 1 ${{ secrets.DEPLOY_HOST }} || echo "Host unreachable"
            exit 1
          }

      - name: Deploy files via rsync
        run: |
          rsync -avz \
            --delete-excluded \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='*.md' \
            --exclude='SSH_KEYS.md' \
            --exclude='.gitignore' \
            -e "ssh -p ${{ secrets.DEPLOY_PORT || 22 }}" \
            index.php build.json \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Verify deployment
        run: |
          ssh -p ${{ secrets.DEPLOY_PORT || 22 }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "ls -lah ${{ secrets.DEPLOY_PATH }}/ && echo '---' && cat ${{ secrets.DEPLOY_PATH }}/build.json"

      - name: Create deployment summary
        if: always()
        run: |
          cat > /tmp/deployment_summary.txt <<EOF
          # Deployment Summary
          
          **Status:** Success âœ“
          **Commit:** ${{ steps.deployment.outputs.commit_short }}
          **Build Timestamp:** ${{ steps.deployment.outputs.build_timestamp }}
          **Deployed to:** ${{ secrets.DEPLOY_HOST }}
          **Path:** ${{ secrets.DEPLOY_PATH }}
          **URL:** https://${{ secrets.DEPLOY_HOST }}/
          
          ## Verification
          
          After deployment, verify the site:
          1. Open https://${{ secrets.DEPLOY_HOST }}/
          2. Check that the commit hash shows: ${{ steps.deployment.outputs.commit_short }}
          3. Check that the PHP version is displayed
          4. Check that the build timestamp is recent
          
          EOF
          cat /tmp/deployment_summary.txt

      - name: Comment deployment result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const commitShort = '${{ steps.deployment.outputs.commit_short }}';
            const buildTimestamp = '${{ steps.deployment.outputs.build_timestamp }}';
            const deployHost = '${{ secrets.DEPLOY_HOST }}';
            
            const comment = `## ðŸš€ Deployment Info
            
            - **Commit:** \`${commitShort}\`
            - **Build Timestamp:** \`${buildTimestamp}\`
            - **Deployed to:** ${deployHost}
            - **Verify at:** https://${deployHost}/
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Deployment failed
        run: |
          echo "âŒ Deployment failed! Check the logs for details."
          exit 1
