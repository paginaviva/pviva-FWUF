name: Deploy PVUF to Shared Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to pvuf.plazza.xyz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate deployment identifier
        id: deployment
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          
          # Create build.json
          cat > build.json <<EOF
          {
            "commitHash": "${COMMIT_HASH}",
            "buildTimestamp": "${BUILD_TIMESTAMP}",
            "buildDate": "${BUILD_DATE}"
          }
          EOF
          
          echo "=== Deployment Info ==="
          cat build.json
          echo ""
          echo "Commit: ${COMMIT_SHORT}"
          echo "Build Timestamp: ${BUILD_TIMESTAMP}"
          echo "Build Date: ${BUILD_DATE}"

      - name: Verify build artifact
        run: |
          echo "=== Files to be deployed ==="
          ls -lah index.php build.json

      - name: Setup SSH with Passphrase Support
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          SSH_KEY_PASSPHRASE: ${{ secrets.DEPLOY_KEY_PASSPHRASE }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          mkdir -p ~/.ssh
          
          # Write private key
          cat > ~/.ssh/deploy_key <<'EOF'
          ${{ secrets.DEPLOY_KEY }}
          EOF
          
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -p ${DEPLOY_PORT:-22} ${DEPLOY_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Create a script to provide passphrase to ssh-add
          cat > /tmp/ssh_passphrase.sh <<'EOFPASS'
          #!/bin/bash
          echo "$SSH_KEY_PASSPHRASE"
          EOFPASS
          chmod +x /tmp/ssh_passphrase.sh
          
          # Start ssh-agent and add key with passphrase
          eval $(ssh-agent -s)
          export SSH_ASKPASS=/tmp/ssh_passphrase.sh
          export SSH_ASKPASS_REQUIRE=force
          echo "$SSH_KEY_PASSPHRASE" | setsid ssh-add ~/.ssh/deploy_key 2>&1 || true
          
          # Export agent info for subsequent steps
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

      - name: Test SSH connection
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          echo "Testing SSH connection to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PORT..."
          ssh -vvv -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "echo 'SSH Connection successful!'; pwd; php --version" || {
            echo ""
            echo "ERROR: SSH connection failed!"
            ping -c 1 $DEPLOY_HOST || echo "Host unreachable"
            exit 1
          }

      - name: Deploy files via SCP
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Starting deployment to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH..."
          
          # Copy files via SCP
          scp -p -P $DEPLOY_PORT index.php $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          scp -p -P $DEPLOY_PORT build.json $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          
          echo "Deployment completed!"

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Verifying deployment..."
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST \
            "ls -lah $DEPLOY_PATH/ && echo '---' && cat $DEPLOY_PATH/build.json"

      - name: Create deployment summary
        if: always()
        run: |
          cat > /tmp/deployment_summary.txt <<EOF
          # Deployment Summary
          
          **Status:** Success âœ“
          **Commit:** ${{ steps.deployment.outputs.commit_short }}
          **Build Timestamp:** ${{ steps.deployment.outputs.build_timestamp }}
          **Deployed to:** ${{ secrets.DEPLOY_HOST }}
          **Path:** ${{ secrets.DEPLOY_PATH }}
          **URL:** https://${{ secrets.DEPLOY_HOST }}/
          
          ## Verification
          
          After deployment, verify the site:
          1. Open https://${{ secrets.DEPLOY_HOST }}/
          2. Check that the commit hash shows: ${{ steps.deployment.outputs.commit_short }}
          3. Check that the PHP version is displayed
          4. Check that the build timestamp is recent
          
          EOF
          cat /tmp/deployment_summary.txt

      - name: Comment deployment result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const commitShort = '${{ steps.deployment.outputs.commit_short }}';
            const buildTimestamp = '${{ steps.deployment.outputs.build_timestamp }}';
            const deployHost = '${{ secrets.DEPLOY_HOST }}';
            
            const comment = `## ðŸš€ Deployment Info
            
            - **Commit:** \`${commitShort}\`
            - **Build Timestamp:** \`${buildTimestamp}\`
            - **Deployed to:** ${deployHost}
            - **Verify at:** https://${deployHost}/
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Deployment failed
        run: |
          echo "âŒ Deployment failed! Check the logs for details."
          exit 1
