name: Deploy PVUF to Shared Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to pvuf.plazza.xyz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate deployment identifier
        id: deployment
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BUILD_TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "build_timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          
          # Create build.json
          cat > build.json <<EOF
          {
            "commitHash": "${COMMIT_HASH}",
            "buildTimestamp": "${BUILD_TIMESTAMP}",
            "buildDate": "${BUILD_DATE}"
          }
          EOF
          
          echo "=== Deployment Info ==="
          cat build.json
          echo ""
          echo "Commit: ${COMMIT_SHORT}"
          echo "Build Timestamp: ${BUILD_TIMESTAMP}"
          echo "Build Date: ${BUILD_DATE}"

      - name: Verify build artifact
        run: |
          echo "=== Files to be deployed ==="
          ls -lah index.php build.json

      - name: Setup SSH Agent with Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}
          ssh-known-hosts: ${{ secrets.DEPLOY_HOST }}

      - name: Test SSH connection
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          echo "Testing SSH connection to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PORT..."
          ssh -vvv -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "echo 'SSH Connection successful!'; pwd; php --version" || {
            echo ""
            echo "ERROR: SSH connection failed!"
            ping -c 1 $DEPLOY_HOST || echo "Host unreachable"
            exit 1
          }

      - name: Deploy files via rsync
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Starting deployment to $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH..."
          rsync -avz \
            --delete-excluded \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='*.md' \
            --exclude='.gitignore' \
            -e "ssh -p $DEPLOY_PORT" \
            index.php build.json \
            $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
          echo "Deployment completed!"

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Verifying deployment..."
          ssh -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST \
            "ls -lah $DEPLOY_PATH/ && echo '---' && cat $DEPLOY_PATH/build.json"

      - name: Create deployment summary
        if: always()
        run: |
          cat > /tmp/deployment_summary.txt <<EOF
          # Deployment Summary
          
          **Status:** Success âœ“
          **Commit:** ${{ steps.deployment.outputs.commit_short }}
          **Build Timestamp:** ${{ steps.deployment.outputs.build_timestamp }}
          **Deployed to:** ${{ secrets.DEPLOY_HOST }}
          **Path:** ${{ secrets.DEPLOY_PATH }}
          **URL:** https://${{ secrets.DEPLOY_HOST }}/
          
          ## Verification
          
          After deployment, verify the site:
          1. Open https://${{ secrets.DEPLOY_HOST }}/
          2. Check that the commit hash shows: ${{ steps.deployment.outputs.commit_short }}
          3. Check that the PHP version is displayed
          4. Check that the build timestamp is recent
          
          EOF
          cat /tmp/deployment_summary.txt

      - name: Comment deployment result on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const commitShort = '${{ steps.deployment.outputs.commit_short }}';
            const buildTimestamp = '${{ steps.deployment.outputs.build_timestamp }}';
            const deployHost = '${{ secrets.DEPLOY_HOST }}';
            
            const comment = `## ðŸš€ Deployment Info
            
            - **Commit:** \`${commitShort}\`
            - **Build Timestamp:** \`${buildTimestamp}\`
            - **Deployed to:** ${deployHost}
            - **Verify at:** https://${deployHost}/
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Deployment failed
        run: |
          echo "âŒ Deployment failed! Check the logs for details."
          exit 1
